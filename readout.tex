\chapter{Upgrades of the sPHENIX Readout}
\label{chap:readout}

In this Chapter we detail two very modest cost upgrades that will significantly enhance the sPHENIX physics program beyond the original proposal.     These both related to the data acquisition and readout.   The first is a continuous streaming readout of the tracking detectors (MVTX, INTT, TPC) and could be available at 10\% capacity for the 2024 running and at 100\% capacity if a future opportunity for running in 2026-2027 were available.   The second is to demultiplex the readout electronics for the calorimeter system which would enable a doubling of the Level-1 trigger date for these detectors from 15 kHz to 30 kHz.   This upgrade could be available for running in 2026-2027.   We detail these two options in the sections below.

\input{streaming_readout}

\section{De-Multiplexing the Calorimeter Readout}
\label{sec:streaming_readout}

\begin{figure}
    \centering
    \includegraphics[width=0.75\linewidth]{figs/sphenixdaq_servers_20200803.pdf}
    \caption{Block diagram of sPHENIX data acquisition system, showing interfaces to MVTX,
    INTT, and TPC front electronics using the ATLAS FELIX interface, and electromagnetic and hadronic calorimeters and Minimum Bias Detector using the DCM2 and JSEB card.}
    \label{fig:sphenixdaq_servers}
\end{figure}

The sPHENIX data acquisition system is designed to acquire events from
front end electronics at 15 kHz and 90\% or greater livetime.
Custom digitizers on the detector have been designed which transmit data over fiber optic cables to computers in the sPHENIX Rack Room which record data to local
fileservers before copying to RACF for archiving and analysis.
A block diagram of the system is shown in Figure \ref{fig:sphenixdaq_servers}.
The system is designed with high speed links and buffering at several points to
achieve the design livetime at 15 kHz event rate.
In the absence of data flow bottlenecks, the livetime is limited by the
ADC system used to read out the three calorimeters and the Minimum Bias Detector.

\begin{figure}
    \centering
    \includegraphics[width=0.55\linewidth]{figs/sphenix_daqrate_3.pdf}
    \caption{Livetime as a function of trigger rate for calorimeter digitizers for
    1, 4, and 8 event buffering in the front end in the baseline design (black),
    and with possible future upgrades (red).}
    \label{fig:sphenix_daqrate}
\end{figure}

The ADC system used by the calorimeters uses 60 MHz waveform digitizers
to record a fixed number of samples at the time of a Level 1 trigger, 
which are buffered locally on the detector for 4, and possibly as many as 8,
events before serialization and transmission over optical fiber from a digitizer "XMIT" board to
second generation PHENIX Data Collection Modules (DCM2) which suppresses zeroes
and formats the data.
The sPHENIX baseline design collects data from 3 ADC modules  (192 channels) to one fiber (by way of a board known as an XMIT), and the time to transmit an event ultimately determines the livetime as a function of event rate.
Assuming there are no data transmission bottlenecks downstream 
which would require throttling the data flow, the transmission time for a single
event is designed to be about 40 $\mu$sec.  
Buffering events at the digitizer makes it possible to achieve above 90\% livetime 
with 15 kHz of input triggers, but the livetime decreases as the trigger
rate approaches 25 kHz, as shown by the black curves in Figure \ref{fig:sphenix_daqrate}.

A possible upgrade to the ADC system which could nearly double
the rate of recorded events while maintaining 90\% livetime would be to decrease the number ADC modules serialized on one fiber in the electromagnetic calorimeter.
Reducing the number of ADC boards per fiber to two would not require more crates on the detector, and would decrease the transmission time to about 28 $\mu$sec, as 
shown by the red curves in Figure \ref{fig:sphenix_daqrate}.

%%%


